
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>7. Further Exercises (2) &#8212; NCAS Unified Model Introduction</title>
    <link rel="stylesheet" href="_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="8. Rose/Cylc Exercises" href="rose-cylc-exercises.html" />
    <link rel="prev" title="6. Further Exercises (1)" href="further-exercises-1.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="rose-cylc-exercises.html" title="8. Rose/Cylc Exercises"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="further-exercises-1.html" title="6. Further Exercises (1)"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">NCAS Unified Model Introduction</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="further-exercises-2">
<h1>7. Further Exercises (2)<a class="headerlink" href="#further-exercises-2" title="Permalink to this headline">¶</a></h1>
<p>The exercises in this section are all optional.  We suggest you pick and choose the exercises that you feel are most relevant to the work you are/will be doing.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Use your copy of suite u-ba799 for these exercises unless otherwise specified.</p>
</div>
<div class="section" id="post-processing-archive-and-transfer-of-model-data">
<h2>7.1. Post-Processing (archive and transfer of model data)<a class="headerlink" href="#post-processing-archive-and-transfer-of-model-data" title="Permalink to this headline">¶</a></h2>
<p>When your model runs it outputs data onto the Archer <code class="docutils literal notranslate"><span class="pre">/work</span></code> disk (<code class="docutils literal notranslate"><span class="pre">/projects</span></code> on Monsoon/NEXCS). If you are running a long integration and/or at high resolution data will mount up very quickly and you will need to move it either to the ARCHER RDF or JASMIN.  The post-processing app (postproc) is used within cycling suites to automatically archive model data and can be optionally configured to transfer the data from the RDF to JASMIN data facility.  The app archives and deletes model output files, not only for the UM, but also NEMO and CICE in coupled configurations.</p>
<p>Let’s try configuring your suite to archive to the RDF:</p>
<ul class="simple">
<li>Switch on post-processsing in window <em>suite conf -&gt; Tasks</em></li>
</ul>
<p>The post-processing is configured under the <strong>postproc</strong> section:</p>
<ul class="simple">
<li>Select the “Archer archiving system” in window <em>Post Processing - common settings</em>.</li>
</ul>
<p>A couple of new entries will have appeared in the index panel, <em>Archer Archiving</em> and <em>JASMIN Transfer</em>, identified with the blue dots.</p>
<p>You now need to specify where you want your archived data to be copied to:</p>
<ul class="simple">
<li>In the <em>Archer Archiving</em> panel set <code class="docutils literal notranslate"><span class="pre">archive_root_dir</span></code> to be <strong>/nerc/n02/n02/&lt;userid&gt;</strong>.  The <em>archive_name</em> (suite id) will be automatically appended to this.</li>
</ul>
<p>You will need to run the model for at least 1 day as archiving doesn’t work for periods of less than 1 day.  Change the <em>“run length”</em> and <em>“cycling frequency”</em> to be 1 day.  This should complete in about 5 minutes so set the <em>“wallclock time”</em> to be 10 minutes.</p>
<p><strong>Run</strong> the suite.</p>
<p>Once the run has completed go to the archive directory for this cycle (e.g. <code class="docutils literal notranslate"><span class="pre">/nerc/n02/n02/&lt;userid&gt;/&lt;suiteid&gt;/19880901T0000Z</span></code>) and you should see several files have been copied over (e.g <code class="docutils literal notranslate"><span class="pre">ba902a.pc19880901_00.pp</span></code>).  Data is only archived when it is no longer required by the model for restarting or for calculating means (seasonal, annual, etc). This run is reinitialising the <code class="docutils literal notranslate"><span class="pre">pc</span></code> data stream every 4 hours and you should see that it has only archived data files up to 16:00hrs (ba902a.pc19880901_16.pp).  The last file containing data for hours 20-24 is still required by the model. Equally seasonal mean files would not be archived until the end of the year, after the annual mean has been created.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The post-processing app can also be configured to transfer the archived data over to JASMIN.  Details on how to do this are available on the CMS website: <a class="reference external" href="http://cms.ncas.ac.uk/wiki/Docs/PostProcessingApp">http://cms.ncas.ac.uk/wiki/Docs/PostProcessingApp</a></p>
</div>
</div>
<div class="section" id="using-io-servers">
<h2>7.2. Using IO Servers<a class="headerlink" href="#using-io-servers" title="Permalink to this headline">¶</a></h2>
<p>Older versions of the UM did not have IO servers, which meant that all reading and writing of fields files went through a single processor (pe0).  When the model is producing lots of data and is running on many processors, this method of IO is very inefficient and costly - when pe0 is writing data, all the other processors have to wait around doing nothing but still consuming AUs.  Later UM versions, including UM 10.5, have IO servers which are processors dedicated to performing IO and which work asynchronously with processors doing the computation.</p>
<p>Here’s just a taste of how to get this working in your suite.</p>
<p>Set the suite to run for 6 hours with an appropriate cycling frequency, then check that OpenMP is switched on (Hint: search for <em>openmp</em> in rose edit) as this is needed for the IO servers to work.</p>
<p>Navigate to <em>suite conf -&gt; Domain Decomposition -&gt; Atmosphere</em> and check the number of OpenMP threads is set to 2. Set the number of <em>“IO Server Processes”</em> to 8.</p>
<p><strong>Save</strong> and then <strong>Run</strong> the suite.</p>
<p>You will see lots of IO server log files in <code class="docutils literal notranslate"><span class="pre">~/cylc-run/&lt;suitename&gt;/work/&lt;cycle&gt;/atmos_main</span></code> which can be ignored for the most part.</p>
<p>Try repeating the “Change dump frequency” experiment with the IO servers switched on - you should see much faster performance.</p>
</div>
<div class="section" id="writing-netcdf-output-from-the-um">
<h2>7.3. Writing NetCDF output from the UM<a class="headerlink" href="#writing-netcdf-output-from-the-um" title="Permalink to this headline">¶</a></h2>
<p>Until UM vn10.9, only fields-file output was available from the UM - bespoke NetCDF output configurations did exist but not on the UM trunk. The suite used in most of these Section 7 exercises is vn11.0, hence supports both fields-file and NetCDF output data formats.</p>
<p><strong>i. Enable NetCDF</strong></p>
<p>Make sure that <strong>IO Server Processes</strong> is set to 0.</p>
<p>Navigate to <em>um -&gt; namelist -&gt; Model Input and Output -&gt; NetCDF Output Options</em> and set <code class="docutils literal notranslate"><span class="pre">l_netcdf</span></code> to true. Several fields will appear which allow you to configure various NetCDF options.  For this exercise, leave them at their chosen values.</p>
<p><strong>ii. Set NetCDF Output Streams</strong></p>
<p>Expand the <em>NetCDF Output Streams</em> section. A single stream - <strong>nc0</strong> - already exists; select it to display its content. As a useful comaprison, expand the <em>Model Output Streams</em> section and with the middle mouse button select <strong>pp0</strong>. Observe that the only significant differences between <strong>pp0</strong> and <strong>nc0</strong> are the values of <code class="docutils literal notranslate"><span class="pre">file_id</span></code> and <code class="docutils literal notranslate"><span class="pre">filename_base</span></code>.  Data compression options for <strong>nc0</strong> are revealed if <code class="docutils literal notranslate"><span class="pre">l_compress</span></code> is set to true. NetCDF deflation is a computationally expensive process best handled asynchronously to computation and as yet not fully implemented through the UM IO Server scheme (but under active development.) For many low- to medium-resolution models and, depending precisely on output profiles, high-resolution models also, use of UM-NetCDF without IO servers still provides significant benefits over fields-file output since using it avoids the need for subsequent file format conversion.</p>
<p>Right-click on <strong>nc0</strong> and select <em>Clone this section</em>. Edit the settings of the newly cloned section appropriately to make the new stream similar to <strong>pp1</strong> (ie. edit <code class="docutils literal notranslate"><span class="pre">filename_base</span></code> and all the reinitialisation variables). It is sensible to change the name of the new stream from “1” to something more meaningful, nc1 for example (right click on “1”, select <em>Rename a section</em>, and change …nc(1) to …nc (nc1)).</p>
<p><strong>iii. Direct output to the nc streams</strong></p>
<p>Expand <em>STASH Requests and Profiles</em>, then expand <em>Usage Profiles</em>. Assign nc streams to usage profiles - in this suite, UPA and UPB are assigned to <strong>pp0</strong> and <strong>pp1</strong> respectively (where can you see this?). Edit these Usage profiles to refer to <strong>nc0</strong> and <strong>nc1</strong> respectively. Run the STASH Macros (if you need a reminder see Section 6), save the changes, and run the suite. Check that the NetCDF output is what you expected.</p>
<p>Try adding more nc streams to mimic the pp stream behaviour.</p>
</div>
<div class="section" id="running-the-coupled-model">
<h2>7.4. Running the coupled model<a class="headerlink" href="#running-the-coupled-model" title="Permalink to this headline">¶</a></h2>
<p>The coupled model consists of the UM Atmosphere model coupled to the NEMO ocean and CICE sea ice models.  The coupled configuration used for this exercise is N96 resolution for the atmosphere and a 1 degree ocean - you will see this written N96 ORCA1.</p>
<p><strong>i. Checkout and run the suite</strong></p>
<p>Checkout and open the suite <strong>u-ak943</strong>.  The first difference you should see is in the naming of the apps; there is a separate build app for the um and ocean, called <em>fcm_make_um</em> and <em>fcm_make_ocean</em> respectively. The model configuration is under <em>coupled</em> rather than <em>um</em>.</p>
<p>Make the usual changes required to run the suite (i.e. set username, account code, queue)</p>
<p>Check that the suite is set to build both the UM and ocean, as well as run the reconfiguration and model.</p>
<p><strong>Run</strong> the suite.</p>
<p><strong>ii. Exploring the suite</strong></p>
<p>Whilst the suite is compiling and running which will take around 45 minutes, take some time to look around the suite.</p>
<ul class="simple">
<li>How many nodes is the atmosphere running on?</li>
<li>How many nodes is the ocean running on?</li>
</ul>
<p>Changing the processor decomposition for the ocean is not as simple as just changing the EW/NS processes.  You also need to:</p>
<ol class="arabic simple">
<li>Recalculate the CICE number of columns per block EW and rows per block NS. (Normally the model is set up so that NEMO and CICE use the same decomposition). Looking at the current settings we calculate as follows:</li>
</ol>
<blockquote>
<div><p>Num of cols per block EW = Num of cols EW / Num of processes EW (E.g. 360 / 9 = 40)</p>
<p>Num of rows per block NS = Num of rows NS / Num of processes NS (E.g. 330 / 8 = 42)</p>
</div></blockquote>
<ol class="arabic simple" start="2">
<li>Recompile the ocean executable. Note the executable comprises both the ocean (NEMO) and sea-ice (CICE) code.</li>
</ol>
<p>Now looked at the <code class="docutils literal notranslate"><span class="pre">coupled</span></code> settings.</p>
<ul class="simple">
<li>Can you see where the NEMO model settings appear?</li>
</ul>
<p>Look under <em>Run settings (namrun)</em>. The variables <code class="docutils literal notranslate"><span class="pre">nn_stock</span></code> and <code class="docutils literal notranslate"><span class="pre">nn_write</span></code> control the frequency of output files.</p>
<ul class="simple">
<li>How often are NEMO restart files written? (Hint the NEMO timestep length is set as variable <code class="docutils literal notranslate"><span class="pre">rn_rdt</span></code>).</li>
</ul>
<p>Now browse the CICE settings.</p>
<ul class="simple">
<li>Can you find what the CICE restart frequency is set to?</li>
</ul>
<p>NEMO and CICE are developed separately from the UM, and you should have seen that they work in very different ways. See the websites for documentation:</p>
<ul class="simple">
<li><a class="reference external" href="http://oceans11.lanl.gov/trac/CICE">http://oceans11.lanl.gov/trac/CICE</a></li>
<li><a class="reference external" href="http://www.nemo-ocean.eu/">http://www.nemo-ocean.eu/</a></li>
</ul>
<p><strong>iii. Output files</strong></p>
<p><strong>Log files</strong></p>
<p>NEMO logging information is written to:</p>
<blockquote>
<div><code class="docutils literal notranslate"><span class="pre">~/cylc-run/&lt;suitename&gt;/work/&lt;cycle&gt;/coupled/ocean.output</span></code></div></blockquote>
<p>CICE logging information is written to:</p>
<blockquote>
<div><code class="docutils literal notranslate"><span class="pre">~/cylc-run/&lt;suitename&gt;/work/&lt;cycle&gt;/coupled/ice_diag.d</span></code></div></blockquote>
<p>If the model fails some error messages may also be written to the file <code class="docutils literal notranslate"><span class="pre">~/cylc-run/&lt;suitename&gt;/work/&lt;cycle&gt;/coupled/debug.root.01</span></code> or <code class="docutils literal notranslate"><span class="pre">debug.root.02</span></code></p>
<p>When something goes wrong with the coupled model it can be tricky to work out what has gone wrong. NEMO errors may not appear at the end of the file but will be flagged with the string <code class="docutils literal notranslate"><span class="pre">E</span> <span class="pre">R</span> <span class="pre">R</span> <span class="pre">O</span> <span class="pre">R</span></code>.</p>
<p><strong>Restart files</strong></p>
<p>Restart files go to the subdirectories <code class="docutils literal notranslate"><span class="pre">NEMOhist</span></code> and <code class="docutils literal notranslate"><span class="pre">CICEhist</span></code> in the standard data directory <code class="docutils literal notranslate"><span class="pre">~/cylc-run/&lt;suitename&gt;/share/data/History_Data</span></code>.</p>
<p><strong>Diagnostic files</strong></p>
<p>Diagnostic files are left in the <code class="docutils literal notranslate"><span class="pre">~/cylc-run/&lt;suitename&gt;/work/&lt;cycle&gt;/coupled/</span></code> directory.</p>
<p>CICE files start with <code class="docutils literal notranslate"><span class="pre">&lt;suitename&gt;i</span></code>. Once your suite has run you should see the following CICE file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>archer$ ls ak943i*
ak943i.10d.1978-09-10.nc
</pre></div>
</div>
<p>NEMO diagnostic files are named <code class="docutils literal notranslate"><span class="pre">&lt;suitename&gt;o*grid_[TUVW]*</span></code>. To see what files are produced, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>archer$ ls ak943o*grid*
</pre></div>
</div>
<p>In this case each processor writes to a separate file. To concatenate these into a global file use the <code class="docutils literal notranslate"><span class="pre">rebuild_nemo</span></code> tool, e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>archer$ rebuild_nemo ak943o_10d_19780901_19780910_grid_W_19780901-19780910 72
</pre></div>
</div>
<p>Higher resolution NEMO suites may use the XIOS IO server. In this case, global files may be written directly, or each server process may write its own file.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The coupled atmos-ocean model setup is complex so we recommend you find a suite already setup for your needs.  If you find you do need to modify a coupled suite setup please contact NCAS-CMS for advice.</p>
</div>
</div>
<div class="section" id="running-the-nesting-suite">
<h2>7.5. Running the Nesting Suite<a class="headerlink" href="#running-the-nesting-suite" title="Permalink to this headline">¶</a></h2>
<p>The Nesting Suite drives a series of nested limited area models (LAM)
from a global model.  It allows the user to specify the domains and it
then automatically creates the required ancillary files and lateral
boundary condition files.</p>
<p><strong>i. Checkout and run the suite</strong></p>
<p>Checkout and open the suite <strong>u-ba621</strong>. There are a number of tasks for
creating ancillary files (<em>ancil_*</em> and <em>ants_*</em>).  The global model set
up is in <em>glm_um</em> and the LAMs are in <em>um</em>.  The task <em>um-createbc</em> creates
the lateral boundary condition files.</p>
<p>Under <em>suite conf -&gt; jinja2:suite.rc</em> are the main panels for
controlling the Nesting Suite. Make the usual changes required to run
the suite (i.e. set username, account code, queue). The training
nesting suite has pre-built executables so you don’t have to spend
time building it.  <strong>Run</strong> the suite.</p>
<p>This particular suite has a global model and one limited area model.
It should complete in about 45 - 60 minutes.</p>
<p><strong>ii. Exploring the Suite</strong></p>
<p>The Driving Model set up panel allows the user to specify the
resolution of the global model and the number of nested regions.</p>
<p>The <em>Nested Region 1</em> set up panel specifies the latitude and longitude
of the centre of the first nested region.  All the other limited area
models have the same centre.</p>
<p>A useful way to get this information is to use Google Maps.  Find the
place you want as a centre and then press <code class="docutils literal notranslate"><span class="pre">control-left</span> <span class="pre">mouse</span></code> and a
little window with the latitude and longitude appears.</p>
<blockquote>
<div><ul class="simple">
<li>Can you find out where the first LAM is located?  Hint: look at the orography file output during the ancillary creation.</li>
</ul>
</div></blockquote>
<p>The <em>resolution 1</em> set up panel specifies the grid and the run length.</p>
<p>The <em>Config 1</em> set up panel specifies the science configuration to be
run.  Each LAM can have multiple science configurations.</p>
<p><strong>iii.  Initial Data</strong></p>
<p>The initial data for the global model is in <code class="docutils literal notranslate"><span class="pre">share/cycle/&lt;cycle</span> <span class="pre">time&gt;/glm/ics</span></code></p>
<p>The initial data for the first LAM is in <code class="docutils literal notranslate"><span class="pre">share/cycle/&lt;cycle</span> <span class="pre">time&gt;/Regn1/resn_1/RA1M/ics</span></code></p>
<p>The RA1M is the name you gave to the first science configuration.</p>
<p>The LBCs for the first LAM are in <code class="docutils literal notranslate"><span class="pre">share/cycle/&lt;cycle</span> <span class="pre">time&gt;/Regn1/resn_1/RA1M/lbcs</span></code>.</p>
<p><strong>iv. The ancillary files</strong></p>
<p>These are in <code class="docutils literal notranslate"><span class="pre">share/data/ancils/Regn1/resn_1</span></code></p>
<p><strong>v.  The output files</strong></p>
<p>The global model output is in <code class="docutils literal notranslate"><span class="pre">share/cycle/&lt;cycle</span> <span class="pre">time&gt;/glm/um</span></code>. This also
contains contains the data for creating the LBC files (umglaa_cb*) for the first LAM.</p>
<p>Diagnostic files can be found under <code class="docutils literal notranslate"><span class="pre">work/&lt;cycle</span> <span class="pre">time&gt;</span></code> in an application directory.  For
example, the region1 forecast diagnostics is in <code class="docutils literal notranslate"><span class="pre">work/&lt;cycle</span> <span class="pre">time&gt;/Regn1_resn_1_RA1M_um_fcst_000</span></code>.
This will include the pe_output files.</p>
<p>The output for the first LAM is in <code class="docutils literal notranslate"><span class="pre">share/cycle/&lt;cycle</span> <span class="pre">time&gt;/Regn1/resn_1/RA1M/um</span></code>.</p>
<p><strong>vi. Further Information</strong></p>
<p>This has been a very brief overview of the functionality of the
Nesting Suite. The Nesting Suite is developed and maintained by Stuart
Webster at the Met Office.  He has a web page all about the Nesting
Suite at <a class="reference external" href="https://code.metoffice.gov.uk/trac/rmed/wiki/suites/nesting">https://code.metoffice.gov.uk/trac/rmed/wiki/suites/nesting</a>.
This includes a more detailed tutorial.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">7. Further Exercises (2)</a><ul>
<li><a class="reference internal" href="#post-processing-archive-and-transfer-of-model-data">7.1. Post-Processing (archive and transfer of model data)</a></li>
<li><a class="reference internal" href="#using-io-servers">7.2. Using IO Servers</a></li>
<li><a class="reference internal" href="#writing-netcdf-output-from-the-um">7.3. Writing NetCDF output from the UM</a></li>
<li><a class="reference internal" href="#running-the-coupled-model">7.4. Running the coupled model</a></li>
<li><a class="reference internal" href="#running-the-nesting-suite">7.5. Running the Nesting Suite</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="further-exercises-1.html"
                        title="previous chapter">6. Further Exercises (1)</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="rose-cylc-exercises.html"
                        title="next chapter">8. Rose/Cylc Exercises</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/further-exercises-2.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="rose-cylc-exercises.html" title="8. Rose/Cylc Exercises"
             >next</a> |</li>
        <li class="right" >
          <a href="further-exercises-1.html" title="6. Further Exercises (1)"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">NCAS Unified Model Introduction</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017-2019, NCAS-CMS.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.6.
    </div>
  </body>
</html>