

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>6. Further Exercises (1) &mdash; NCAS Unified Model Introduction</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="7. Further Exercises (2)" href="further-exercises-2.html" />
    <link rel="prev" title="5. Solving Common UM Problems" href="solving-problems.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> NCAS Unified Model Introduction
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Practicals</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting-setup.html">1. Getting set up (7th-9th February, Leeds)</a></li>
<li class="toctree-l1"><a class="reference internal" href="working-with-suites.html">2. Working with Suites</a></li>
<li class="toctree-l1"><a class="reference internal" href="running.html">3. Running a UM suite on ARCHER2</a></li>
<li class="toctree-l1"><a class="reference internal" href="fcm-tutorial.html">4. FCM tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="solving-problems.html">5. Solving Common UM Problems</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">6. Further Exercises (1)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#change-the-model-output-logging-behaviour">6.1. Change the model output logging behaviour</a></li>
<li class="toctree-l2"><a class="reference internal" href="#change-the-processor-decomposition">6.2. Change the processor decomposition</a></li>
<li class="toctree-l2"><a class="reference internal" href="#stash">6.3. STASH</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#exploring-stash">Exploring STASH</a></li>
<li class="toctree-l3"><a class="reference internal" href="#stash-validation-macro">STASH validation macro</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-a-new-stash-request">Adding a new STASH request</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#change-the-dump-frequency">6.4. Change the dump frequency</a></li>
<li class="toctree-l2"><a class="reference internal" href="#reconfiguration">6.5. Reconfiguration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#setting-up-a-suite-to-cycle">6.6. Setting up a suite to cycle</a></li>
<li class="toctree-l2"><a class="reference internal" href="#restarting-a-suite">6.7. Restarting a suite</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="further-exercises-2.html">7. Further Exercises (2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="rose-cylc-exercises.html">8. Rose/Cylc Exercises</a></li>
<li class="toctree-l1"><a class="reference internal" href="post-processing.html">9. Post processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="useful-information.html">10. Appendix A: Useful information</a></li>
<li class="toctree-l1"><a class="reference internal" href="ssh-tasks.html">11. Appendix B: SSH FAQs</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">NCAS Unified Model Introduction</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li><span class="section-number">6. </span>Further Exercises (1)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/further-exercises-1.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="further-exercises-1">
<h1><span class="section-number">6. </span>Further Exercises (1)<a class="headerlink" href="#further-exercises-1" title="Permalink to this headline">¶</a></h1>
<p>Now that we have built the suite, there is no need to rebuild it each time you run it.  Switch off compilation of the UM and reconfiguration.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>See the <span class="guilabel">suite conf</span> section in the Rose edit GUI.</p>
</div>
<div class="section" id="change-the-model-output-logging-behaviour">
<h2><span class="section-number">6.1. </span>Change the model output logging behaviour<a class="headerlink" href="#change-the-model-output-logging-behaviour" title="Permalink to this headline">¶</a></h2>
<p>Navigate to <span class="guilabel">um –&gt; namelist –&gt; Top Level Model Control –&gt; Run Control and Time Settings</span>.</p>
<p>Set <code class="docutils literal notranslate"><span class="pre">ltimer</span></code> to <code class="docutils literal notranslate"><span class="pre">True</span></code>.  Timer diagnostics outputs timing information and can be very useful in diagnosing performance problems.</p>
<p><span class="guilabel">Save</span> and <span class="guilabel">Run</span> the suite.</p>
<p>Check the output from processor 0 in the``fort6.pe000`` file.</p>
<ul class="simple">
<li><p>Which routine took the most time?</p></li>
<li><p>How many times was <code class="docutils literal notranslate"><span class="pre">Atm_Step</span></code> called?</p></li>
<li><p>How many time steps did the model run for?</p></li>
<li><p>Which PE was the slowest to run AP2 Boundary Layer? Which was the fastest?</p></li>
</ul>
<p>Switch on “IO timing”</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Look in the <span class="guilabel">IO System Settings</span> panel.</p>
</div>
<p><span class="guilabel">Re-run</span> the model and search for “Total IO Timings” in the <code class="docutils literal notranslate"><span class="pre">job.out</span></code> file.</p>
</div>
<div class="section" id="change-the-processor-decomposition">
<h2><span class="section-number">6.2. </span>Change the processor decomposition<a class="headerlink" href="#change-the-processor-decomposition" title="Permalink to this headline">¶</a></h2>
<p>Navigate to <span class="guilabel">suite conf –&gt; Domain Decomposition –&gt; Atmosphere</span>.</p>
<ul class="simple">
<li><p>What is the current processor decomposition?</p></li>
<li><p>Why is this not a good way to run the model?</p></li>
</ul>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>The base ARCHER2 charging unit is a node irrespective of how many cores on the node are being used. ARCHER2 has 128 cores per node, and for the UM each MPI task and OpenMP thread is mapped to a separate core.  So in this case we are running 10x16 (x 2 OMP threads) for a total of 320 cores, but are charged for 3 nodes (384 cores).</p>
</div>
<p>Try experimenting with different processor decompositions (E.g. 10x32, 16x32, etc)</p>
<ul class="simple">
<li><p>How do the timings compare to when you ran on 3 nodes?</p></li>
</ul>
<p>You can come up with a performance vs processor count curve in this way which might be valuable if you are planning an experiment - it’s also worth adding in the CU cost calculation when doing this.  An example of this can be seen below:</p>
<a class="reference internal image-reference" href="_images/cost-curves.jpg"><img alt="_images/cost-curves.jpg" src="_images/cost-curves.jpg" style="width: 650px; height: 366px;" /></a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Running “under populated”, i.e. with fewer than the total cores per node, gives access to more memory per parallel task.</p>
</div>
<p>Change the processor decomposition to run fully populated on 3 nodes with 2 OpenMP threads.</p>
</div>
<div class="section" id="stash">
<h2><span class="section-number">6.3. </span>STASH<a class="headerlink" href="#stash" title="Permalink to this headline">¶</a></h2>
<div class="section" id="exploring-stash">
<h3>Exploring STASH<a class="headerlink" href="#exploring-stash" title="Permalink to this headline">¶</a></h3>
<p>Navigate to <span class="guilabel">um –&gt; namelist –&gt; Model Input and Output –&gt; STASH Requests and Profiles</span>. Look at the time profiles called <code class="docutils literal notranslate"><span class="pre">TALLTS</span></code> and <code class="docutils literal notranslate"><span class="pre">T6H</span></code>.</p>
<ul class="simple">
<li><p>What are they doing?</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">TALLTS</span></code> says output on every timestep, <code class="docutils literal notranslate"><span class="pre">T6H</span></code> says output 6 hourly.</p>
<p>Look also at some of the other time, domain and usage profiles.  The domain profiles determine spatial output and the usage profiles effectively specify a Fortran LUN (Logical Unit Number) on which the associated data is written.</p>
<p>Click on <span class="guilabel">STASH Requests</span>. Now change the time profile for all stash output whose <code class="docutils literal notranslate"><span class="pre">Usage</span></code> profile is UPC and <code class="docutils literal notranslate"><span class="pre">Time</span></code> profile is T6H. To do this, click on each diagnostic you wish to change and then click the time profile, a drop-down list should appear containing all the available time profiles.  Select <code class="docutils literal notranslate"><span class="pre">TALLTS</span></code>.  You can sort the STASH table to make it more convenient to make these changes.  Click on the <code class="docutils literal notranslate"><span class="pre">use_name</span></code> column header to sort by usage profile.</p>
</div>
<div class="section" id="stash-validation-macro">
<h3>STASH validation macro<a class="headerlink" href="#stash-validation-macro" title="Permalink to this headline">¶</a></h3>
<p>Several Rose macros have been provided to help verify STASH setup.  When you change STASH it is always recommended to run at least the validate macro. The <em>stash_testmask.STASHTstmskValidate</em> macro ensures that the STASH output requsted is valid given the science configuration of the app.  To put this to the test run the STASH validation macro by selecting <span class="guilabel">stash_testmask.STASHTstmskValidate</span> from the list of available macros at the top of the STASH requests panel or alternatively it can be accessed from the <span class="guilabel">Metadata –&gt; um</span> menu.</p>
<p>You should see several errors reported - it appears we have asked for diagnostics which are not available.  This won’t cause the model to fail, however, you could find these diagnostics in the list and switch them off by unchecking the “incl?” column, if you’d like to stop seeing this message.</p>
<p><span class="guilabel">Save</span> and <span class="guilabel">Re-run</span> the suite.</p>
<p>The model should fail with an error message similar to the following:</p>
<blockquote>
<div><p><strong>STWORK: Number of fields exceeds reserved headers for unit  14</strong></p>
</div></blockquote>
<p>This means that the number of output fields exceeds the limit set for a particular stream (the default is 4096 fields); in this case the stream attached to unit 14.  To find out what stream unit 14 is take a look in the <code class="docutils literal notranslate"><span class="pre">job.out</span></code> file and search for “unit 14”. You should see that the file opened on unit 14 is <code class="docutils literal notranslate"><span class="pre">&lt;suite-id&gt;a.pc19880901</span></code>, so this is the <code class="docutils literal notranslate"><span class="pre">pc</span></code> stream.  Back in <code class="docutils literal notranslate"><span class="pre">rose</span> <span class="pre">edit</span></code> for this suite look at the STASH usage profile for <code class="docutils literal notranslate"><span class="pre">upc</span></code>.</p>
<ul class="simple">
<li><p>What is the file ID of the failing output stream?</p></li>
</ul>
<p>Now navigate to the window for this stream under <span class="guilabel">Model Input and Output –&gt; Model Output Streams</span>.  This defines the output stream.  You should see confirmation of the base output file name to be <code class="docutils literal notranslate"><span class="pre">*.pc*</span></code>.  Changing the reinitialisation frequency by modifying <code class="docutils literal notranslate"><span class="pre">reinit_step</span></code> and/or <code class="docutils literal notranslate"><span class="pre">reinit_unit</span></code> is the best way to fix this header problem. This tells the model to create new output files at a specified frequency, so individual files don’t get massively large.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the model is only exceeding the numer of reserved headers by a small amount it is also possible to just increased the <code class="docutils literal notranslate"><span class="pre">reserved_headers</span></code> size.  Overriding the size by a large amount and thus having large numbers of fieldsfile headers can be very inefficient for both runtime and memory. Therefore the recommended way is to change the periodic reinitialisation of the fieldsfiles.</p>
</div>
<p>Modify the reinitialisation frequency (you will need to experiment with the numbers) and run the model again. Take a look at the model output files. You should see that you have multiple <code class="docutils literal notranslate"><span class="pre">*.pc19980901_*</span></code> files.</p>
</div>
<div class="section" id="adding-a-new-stash-request">
<h3>Adding a new STASH request<a class="headerlink" href="#adding-a-new-stash-request" title="Permalink to this headline">¶</a></h3>
<p>Let’s now try adding a new STASH request to the UM app.</p>
<p>Click the <span class="guilabel">New</span> button in the STASH Requests section.  A window will appear in order for you to browse all available STASHmaster entries.</p>
<p>By default STASHmaster entries are grouped together by Section code. It is possible to group items by any of the STASHmaster codes using the Group drop down list. The <span class="guilabel">View</span> button contains options to display the STASHmaster entry values and/or the column titles with explanation text and to select which columns to show/hide.</p>
<p>Expand the <span class="guilabel">Gravity wave drag</span> section.  Then change the view by selecting <span class="guilabel">View –&gt; Show expanded value info</span>. Try out the other options in the <span class="guilabel">View</span> menu to see what effect they have.</p>
<p>Select a STASH item and click <span class="guilabel">Add</span> to add it to the list of STASH requests.  In the STASH Requests panel click on the empty <code class="docutils literal notranslate"><span class="pre">dom_name</span></code>, <code class="docutils literal notranslate"><span class="pre">tim_name</span></code> and <code class="docutils literal notranslate"><span class="pre">use_name</span></code> fields of the new request and select appropriate profiles from the drop down lists.  These lists are populated from the entries of the time, use and domain namelists.</p>
<p>Once you have added a new STASH request, you need to run a macro to generate an index for the namelist.  To do so click on the <span class="guilabel">Macros</span> button, then select <span class="guilabel">stash_indices.TidyStashTransform</span>. A box will pop up listing the changes the editor is going to make, click <span class="guilabel">Apply</span>.</p>
<ul class="simple">
<li><p>Run the model.  Did it work?</p></li>
</ul>
</div>
</div>
<div class="section" id="change-the-dump-frequency">
<span id="change-dump-freq"></span><h2><span class="section-number">6.4. </span>Change the dump frequency<a class="headerlink" href="#change-the-dump-frequency" title="Permalink to this headline">¶</a></h2>
<p>Set the model run length to 6 hours.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Look in the <span class="guilabel">suite conf –&gt; Run Initialisation and Cycling</span>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Hours are represented in the ISO 8601 standard as <code class="docutils literal notranslate"><span class="pre">PT&lt;num-hours&gt;H</span></code> (e.g. <code class="docutils literal notranslate"><span class="pre">PT1H</span></code> represents 1 hour). Days are represented as <code class="docutils literal notranslate"><span class="pre">P&lt;num-days&gt;D</span></code> (e.g. <code class="docutils literal notranslate"><span class="pre">P10D</span></code> represents 10 days)</p>
</div>
<p>Reset the STASH output for stream UPC to 6 hourly and the file reinitialisation frequency to daily.</p>
<p>Navigate to <span class="guilabel">um –&gt; namelist –&gt; Model Input and Output –&gt; Dumping and Meaning</span>.</p>
<ul class="simple">
<li><p>What is the current dump frequency?</p></li>
</ul>
<p>Set the dump frequency to 6 hours.  <span class="guilabel">Run</span> the model.</p>
<ul class="simple">
<li><p>How much time was spent in <code class="docutils literal notranslate"><span class="pre">DUMPCTL</span></code>?</p></li>
</ul>
<p>Set the dump frequency to 1 hour. <span class="guilabel">Run</span> the model.</p>
<ul class="simple">
<li><p>What happened to the time spent in <code class="docutils literal notranslate"><span class="pre">DUMPCTL</span></code>?</p></li>
</ul>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>It is important to understand that writing out model dumps, particularly at higher resolutions, takes up a large amount of time and contributes to the cost.  You should think about how frequently you need to output model dumps when setting up your simulations.</p>
</div>
</div>
<div class="section" id="reconfiguration">
<h2><span class="section-number">6.5. </span>Reconfiguration<a class="headerlink" href="#reconfiguration" title="Permalink to this headline">¶</a></h2>
<p>Try to find out how to run the reconfiguration only.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Look in the <span class="guilabel">suite conf</span> section.</p>
</div>
<p>Try to find out where to request extra diagnostic messages for the reconfiguration output.</p>
<p><span class="guilabel">Run</span> the reconfiguration only with extra diagnostic messages.</p>
<p>Look at the <code class="docutils literal notranslate"><span class="pre">job.out</span></code> file.</p>
<ul class="simple">
<li><p>Do you see a land-sea mask?</p></li>
</ul>
</div>
<div class="section" id="setting-up-a-suite-to-cycle">
<h2><span class="section-number">6.6. </span>Setting up a suite to cycle<a class="headerlink" href="#setting-up-a-suite-to-cycle" title="Permalink to this headline">¶</a></h2>
<p>We mentioned in the presentations that the length of an integration will be limited by the time that a model is allowed to run on the HPC (see the ARCHER2 web pages for information about the time limits).  Clearly this is no good for much of our work which may need to run on the machine for several months.  Cylc and the UM allow for long integrations to be split up into multiple shorter jobs - this is called <strong>cycling</strong>.</p>
<p>Let’s run the model for 1 day with 6 hour cycling:</p>
<ul class="simple">
<li><p>Set the <code class="docutils literal notranslate"><span class="pre">Total</span> <span class="pre">run</span> <span class="pre">length</span></code> to 1 day.</p></li>
<li><p>Set the <code class="docutils literal notranslate"><span class="pre">Cycling</span> <span class="pre">frequency</span></code> to 6 hours.</p></li>
<li><p>Set the <code class="docutils literal notranslate"><span class="pre">Wallclock</span> <span class="pre">time</span></code> to 10 minutes.</p></li>
<li><p>Ensure that the model dump frequency is 6 hourly, in this case.</p></li>
</ul>
<p><span class="guilabel">Save</span> and <span class="guilabel">Run</span> the suite.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The cycling frequency must be a multiple of the dump frequency.</p>
</div>
<p>The model will submit the first cycle and once that has succeeded you will see the following 3 cycles submitted and run.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is always wise, particularly when you plan to run a long integration, that you only run the first cycle initially so that you can check that the model is doing what you expect before committing to a longer simulation.  It also enables you to determine how long it takes your model to run and thus be able to calculate an appropriate cycling frequency for your simulation.</p>
</div>
</div>
<div class="section" id="restarting-a-suite">
<h2><span class="section-number">6.7. </span>Restarting a suite<a class="headerlink" href="#restarting-a-suite" title="Permalink to this headline">¶</a></h2>
<p>Let’s now extend this run out to 2 days.  Change the <code class="docutils literal notranslate"><span class="pre">Total</span> <span class="pre">run</span> <span class="pre">length</span></code> to <code class="docutils literal notranslate"><span class="pre">2</span></code> days and <span class="guilabel">Save</span> the suite.</p>
<p>Having already run the first day we just want the suite to pick up where it left off and run the remaining day.  To do this we <em>restart</em> the suite, by typing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>puma$ rose suite-run --restart
</pre></div>
</div>
<p>The cylc GUI will pop up and you should see the run resuming from where it left off (i.e. from cycle point <code class="docutils literal notranslate"><span class="pre">19880902T0000Z</span></code>).</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="further-exercises-2.html" class="btn btn-neutral float-right" title="7. Further Exercises (2)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="solving-problems.html" class="btn btn-neutral float-left" title="5. Solving Common UM Problems" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2017-2023, NCAS-CMS.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>