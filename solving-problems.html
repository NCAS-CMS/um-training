

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>5. Solving Common UM Problems &mdash; NCAS Unified Model Introduction</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="6. Further Exercises (1)" href="further-exercises-1.html" />
    <link rel="prev" title="4. FCM tutorial" href="fcm-tutorial.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> NCAS Unified Model Introduction
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Practicals</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting-setup.html">1. Getting set up</a></li>
<li class="toctree-l1"><a class="reference internal" href="working-with-suites.html">2. Working with Suites</a></li>
<li class="toctree-l1"><a class="reference internal" href="running.html">3. Running a UM suite on ARCHER2</a></li>
<li class="toctree-l1"><a class="reference internal" href="fcm-tutorial.html">4. FCM tutorial</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">5. Solving Common UM Problems</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#set-up-n96-ga7-0-amip-example-suite">5.1. Set up N96 GA7.0 AMIP example suite</a></li>
<li class="toctree-l2"><a class="reference internal" href="#errors-resolved-in-the-code-extraction">5.2. Errors resolved in the code extraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#errors-resolved-in-the-compile-and-run">5.3. Errors resolved in the compile and run</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="further-exercises-1.html">6. Further Exercises (1)</a></li>
<li class="toctree-l1"><a class="reference internal" href="further-exercises-2.html">7. Further Exercises (2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="rose-cylc-exercises.html">8. Rose/Cylc Exercises</a></li>
<li class="toctree-l1"><a class="reference internal" href="post-processing.html">9. Post processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="useful-information.html">10. Appendix A: Useful information</a></li>
<li class="toctree-l1"><a class="reference internal" href="ssh-tasks.html">11. Appendix B: SSH FAQs</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">NCAS Unified Model Introduction</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li><span class="section-number">5. </span>Solving Common UM Problems</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/solving-problems.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="solving-common-um-problems">
<h1><span class="section-number">5. </span>Solving Common UM Problems<a class="headerlink" href="#solving-common-um-problems" title="Permalink to this headline">¶</a></h1>
<p>This section exposes you to more typical UM errors and hints at how to find and fix those errors.</p>
<p>You may encounter other errors, often as a result of mistyping, for which solution hints are not provided.</p>
<div class="section" id="set-up-n96-ga7-0-amip-example-suite">
<h2><span class="section-number">5.1. </span>Set up N96 GA7.0 AMIP example suite<a class="headerlink" href="#set-up-n96-ga7-0-amip-example-suite" title="Permalink to this headline">¶</a></h2>
<p>Find and make a copy of suite <code class="docutils literal notranslate"><span class="pre">u-cc654</span></code>.</p>
<p>Firstly make the essential changes required to run the suite.  That is:</p>
<ul class="simple">
<li><p>The account code (‘n02-training’)</p></li>
<li><p>Your ARCHER2 user name</p></li>
<li><p>The queue to run in.</p></li>
</ul>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Look in the <span class="guilabel">suite conf</span> section.  You will see that this suite has the queue reservations listed as Wednesday, Thursday, Friday; select the appropriate day.</p>
</div>
<ul class="simple">
<li><p>Did you manage to find where to set your ARCHER2 username?</p></li>
</ul>
<p>This suite is set up slightly differently to the one used in the previous sections; suites do vary on how they are set up but you will soon learn where to look for things.  This suite is set up so that specifying your username on the remote HPC is optional.  If your PUMA username is the same as your username on ARCHER2, or if the remote username is set in your <code class="docutils literal notranslate"><span class="pre">~/.ssh/config</span></code> file Cylc will be able to submit your suite without having to explicitly set your username in the suite.</p>
<div class="admonition-todo admonition" id="id1">
<p class="admonition-title">Todo</p>
<p>Possibly remove…..However, on this course, we are using training accounts on ARCHER so you will need to set the username.</p>
</div>
<ul class="simple">
<li><p>Click <span class="guilabel">View –&gt; View Latent Variables</span>. You should see <code class="docutils literal notranslate"><span class="pre">HPC_USER</span></code> appear in the panel greyed out.</p></li>
<li><p>Click the <span class="guilabel">+</span> sign next to it and select <span class="guilabel">Add to configuration</span></p></li>
<li><p>Enter your ARCHER2 username (e.g. ‘ncastr01’)</p></li>
</ul>
</div>
<div class="section" id="errors-resolved-in-the-code-extraction">
<h2><span class="section-number">5.2. </span>Errors resolved in the code extraction<a class="headerlink" href="#errors-resolved-in-the-code-extraction" title="Permalink to this headline">¶</a></h2>
<p><span class="guilabel">Save</span> the suite and then <span class="guilabel">Run</span> it either from the GUI or the command line.</p>
<p>The suite should fail in the <code class="docutils literal notranslate"><span class="pre">fcm_make_um</span></code> task. This is the task that extracts all the required code from the repository including any branches.  The failure will be indicated in the Cylc GUI with a red square and the state <code class="docutils literal notranslate"><span class="pre">failed</span></code>.</p>
<ul class="simple">
<li><p>What is the error?</p></li>
</ul>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Examine the <code class="docutils literal notranslate"><span class="pre">job.err</span></code> and <code class="docutils literal notranslate"><span class="pre">job.out</span></code> to find the cause of the problem. You can view these files through Rose Bush, as we have done previously, however you can also view them quickly and easily directly from the Cylc GUI.  <strong>Right-click</strong> on the failed <code class="docutils literal notranslate"><span class="pre">fcm_make_um</span></code> task and select <span class="guilabel">View -&gt; job stderr</span></p>
</div>
<p>This indicates that the branch cannot be found due to an incorrect branch name. You will need to look at the UM code repository through Trac either on MOSRS (<a class="reference external" href="https://code.metoffice.gov.uk/trac/um/browser">https://code.metoffice.gov.uk/trac/um/browser</a>) or the PUMA mirror (<a class="reference external" href="https://puma.nerc.ac.uk/trac/um.xm/browser">https://puma.nerc.ac.uk/trac/um.xm/browser</a> with username: guest1 and password: tra1n1ng or use your own) to determine the correct name.</p>
<p>Fix the error, <span class="guilabel">Save</span> the suite.</p>
<p>Now we will stop the suite and then re-run it.  In the Cylc GUI click on <span class="guilabel">Control &gt; Stop Suite</span> and then select <span class="guilabel">Stop now</span> and then click on <span class="guilabel">OK</span>.  <span class="guilabel">Run</span> the suite again.</p>
<p>The suite will fail in the <code class="docutils literal notranslate"><span class="pre">fcm_make_um</span></code> task again.</p>
<ul class="simple">
<li><p>What is the error?</p></li>
</ul>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Again look in the <code class="docutils literal notranslate"><span class="pre">job.err</span></code> file.  This kind of error results when changes made in two or more branches affect the same bit of code and which the FCM system cannot understand how to resolve.</p>
</div>
<ul class="simple">
<li><p>Which file does the problem occur in?</p></li>
</ul>
<p>In practice, you will need to fix the problem with the code conflict as you did in the FCM tutorial section.  To proceed in this case, navigate to <span class="guilabel">fcm_make_um –&gt; sources</span> and remove the branch called <code class="docutils literal notranslate"><span class="pre">vn11.7_training_merge_error</span></code> by clicking on it and then clicking the <span class="guilabel">-</span> sign.</p>
<p><span class="guilabel">Save</span> the suite.</p>
<p>Last time we stopped the suite and then re-ran it, however, it is possible to reload the suite definition and then re-trigger the failed task without first stopping the running suite. To do this change to the suite directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>puma$ cd ~/roses/&lt;suitename&gt;
</pre></div>
</div>
<p>We then reload the suite definition by running the following Rose command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>puma$ rose suite-run --reload
</pre></div>
</div>
<p>Wait for this command to complete before continuing. Finally in the Cylc GUI <em>right-click</em> on the failed task and select <span class="guilabel">Trigger (run now)</span>.  The <code class="docutils literal notranslate"><span class="pre">fcm_make_um</span></code> task will then submit again.</p>
<ul class="simple">
<li><p>Is there an error in <code class="docutils literal notranslate"><span class="pre">fcm_make_um</span></code> this time?</p></li>
</ul>
<p>If you look in the <code class="docutils literal notranslate"><span class="pre">job.err</span></code> file now it should be empty and the <code class="docutils literal notranslate"><span class="pre">job.out</span></code> file indicates SUCCESS.</p>
</div>
<div class="section" id="errors-resolved-in-the-compile-and-run">
<h2><span class="section-number">5.3. </span>Errors resolved in the compile and run<a class="headerlink" href="#errors-resolved-in-the-compile-and-run" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Has the <code class="docutils literal notranslate"><span class="pre">fcm_make2_um</span></code> (compilation) task completed successfully?</p></li>
<li><p>You should have a failure.  Open the <code class="docutils literal notranslate"><span class="pre">job.err</span></code> file - what does it indicate?</p></li>
<li><p>Which routine has an error?</p></li>
<li><p>What is the error?</p></li>
<li><p>What line of the Fortran file does it occur on?</p></li>
</ul>
<p>In practice, you would need to fix the error in your branch on PUMA and then restart the suite.  In this case, navigate to <span class="guilabel">fcm_make_um –&gt; sources</span> and remove the branch <code class="docutils literal notranslate"><span class="pre">vn11.7_training_compile_error</span></code>.  <span class="guilabel">Save</span> the suite, <span class="guilabel">Shutdown</span> or <span class="guilabel">Stop</span> the failed run and then <span class="guilabel">Run</span> it again.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>This time we chose to shutdown the failed suite rather than do a reload.  In this scenario we need to redo the code extraction (<code class="docutils literal notranslate"><span class="pre">fcm_make_um</span></code>) step so doing a reload would be slightly more complex; you would need to <span class="guilabel">Reload</span> and then <span class="guilabel">Re-trigger</span> both the <code class="docutils literal notranslate"><span class="pre">fcm_make_um</span></code> and the <code class="docutils literal notranslate"><span class="pre">fcm_make2_um</span></code> tasks.  With experience you get to know when it’s better to do a <span class="guilabel">Reload</span> and when to <span class="guilabel">Shutdown</span>  a suite.</p>
</div>
<p>Note again that the task submitted successfully.</p>
<ul class="simple">
<li><p>Did the <code class="docutils literal notranslate"><span class="pre">fcm_make2_um</span></code> task succeed this time?</p></li>
<li><p>What about the <code class="docutils literal notranslate"><span class="pre">install_cold</span></code> task?</p></li>
<li><p>What is the error?</p></li>
<li><p>Does the start dump exist?</p></li>
<li><p>What is the name of the correct start dump?</p></li>
</ul>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Look in the directory where it thinks the start file should be - is there a candidate in there?</p>
</div>
<p>Point your suite to the correct start dump.  Fixing this problem isn’t quite as easy as it sounds.  A search for <code class="docutils literal notranslate"><span class="pre">ainitial</span></code> in the Rose edit GUI will take you to the <span class="guilabel">General technical options</span> panel.</p>
<ul class="simple">
<li><p>Can you see the problem?</p></li>
</ul>
<p>The initial dump location is set with an environment variable: <code class="docutils literal notranslate"><span class="pre">AINITIAL</span></code>.  Suites can be and are set up differently and there will be times when you need to edit the cylc suite definition files directly.</p>
<p>In your suite directory on PUMA (<code class="docutils literal notranslate"><span class="pre">~/roses/&lt;suitename&gt;</span></code>) use <code class="docutils literal notranslate"><span class="pre">grep</span> <span class="pre">-R</span></code> to search for where the variable <code class="docutils literal notranslate"><span class="pre">AINITIAL</span></code> is set (If you are unfamiliar with using <cite>grep</cite> please ask for help).  Edit <code class="docutils literal notranslate"><span class="pre">AINITIAL</span></code> in the appropriate <code class="docutils literal notranslate"><span class="pre">.rc</span></code> file to point to the correct initial dump file.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>This suite is set up to run on multiple platforms, make sure you edit the file appropriate to ARCHER2. You may notice that <code class="docutils literal notranslate"><span class="pre">AINITIAL</span></code> is set 3 times; a different file is required depending on the resolution the model is being run at.  This suite is running at N96 resolution.</p>
</div>
<p><span class="guilabel">Reload</span> the suite definition and then <span class="guilabel">Re-trigger</span> the reconfiguration task.  The reconfiguration should succeed this time.</p>
<ul class="simple">
<li><p>Has the model run successfully?</p></li>
</ul>
<p>This time the model should have failed with an error.</p>
<ul class="simple">
<li><p>What is the error message?</p></li>
</ul>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Try searching for <code class="docutils literal notranslate"><span class="pre">ERROR</span></code> - you will soon learn common phrases to help track down problems.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you use the search <code class="docutils literal notranslate"><span class="pre">job.err</span></code> box at the bottom of the gcylc viewer, when you select <span class="guilabel">Find Next</span> you will see a message indicating the live feed will be disconnected. Click <span class="guilabel">Close</span>.</p>
</div>
<ul class="simple">
<li><p>At what timestep did the error occur?</p></li>
<li><p>Which PE Ranks signalled the Abort?  Make a note of which ones</p></li>
</ul>
<p>Change to the <code class="docutils literal notranslate"><span class="pre">pe_output</span></code> directory for the atmos_main task. This is under <code class="docutils literal notranslate"><span class="pre">~/cylc-run/&lt;suite-id&gt;/work/&lt;cycle&gt;/atmos_main/pe_output</span></code> and contains the output from each PE.</p>
<p>Open the file called <code class="docutils literal notranslate"><span class="pre">&lt;suite-id&gt;.fort6.pe&lt;pe</span> <span class="pre">noted</span> <span class="pre">above&gt;</span></code>.  Sometimes extra information about the error can be found in the individual PE output files.</p>
<p>The error message indicates that NaNs (NaN stands for Not a Number and is a numeric data type representing an undefined or unrepresentable value) have occurred in the routine <code class="docutils literal notranslate"><span class="pre">EG_BICGSTAB</span></code>.  This basically means something in the model has become unstable and “blown up”. In this case the failure results from an incorrect value for the solar constant <code class="docutils literal notranslate"><span class="pre">sc</span></code>.  You could try to find what setting similar models use (with the MOSRS repository you have access to all model setups) or looking at the help within <code class="docutils literal notranslate"><span class="pre">rose</span> <span class="pre">edit</span></code> may point you in the right direction.  Go to <span class="guilabel">um –&gt; namelist –&gt; UM Science Settings –&gt; Planet Constants</span> and set it to the suggested value. <span class="guilabel">Save</span>, <span class="guilabel">Reload</span> and <span class="guilabel">Re-trigger</span>.</p>
<p>The model should fail with the same error.  So what’s gone wrong here?  We’ve changed the value of the solar constant to a valid value so why didn’t it work?  The first thing to check is that the new value has indeed been passed to the model.  We do this by checking the variable in the namelists which are written by the Rose system. On ARCHER2 navigate to the work directory for the <code class="docutils literal notranslate"><span class="pre">atmos_main</span></code> task (ie. <code class="docutils literal notranslate"><span class="pre">~/cylc-run/&lt;suite-id&gt;/work/&lt;cycle&gt;/atmos_main</span></code>).  In here you will see several files with uppercase names (e.g. <code class="docutils literal notranslate"><span class="pre">ATMOSCNTL</span></code>, <code class="docutils literal notranslate"><span class="pre">SHARED</span></code>), these contain the Fortran namelists which are read into the model.  Have a look inside one of them to see the structure.  Now search (use <cite>grep</cite>) in these files for the solar constant variable <code class="docutils literal notranslate"><span class="pre">sc</span></code>.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Search for the string <code class="docutils literal notranslate"><span class="pre">sc=</span></code>.</p>
</div>
<ul class="simple">
<li><p>What value does it have?  Is this what you changed it to in the Rose edit GUI?</p></li>
</ul>
<p>So why was the change not picked up?  Go back to view the setting in the Rose GUI.  By the side of the variable <code class="docutils literal notranslate"><span class="pre">sc</span></code> there is a little icon of a hand on paper, this indicates that there is an <em>“optional configuration override”</em> for this variable.</p>
<p>Optional configuration overrides add to or overwrite the default configuration. They are useful to make it easier to switch between different configurations of the model.  For example switching between different resolutions.</p>
<p>Click on the icon and the list of overrides appears.  You will see that the variable is set to 120000.0 in the <em>training</em> override file and it is this value that is being used in the model.  Unfortunately optional configuration override files cannot be changed through the GUI so we will need to edit the Rose file directly. Override files for the <code class="docutils literal notranslate"><span class="pre">um</span></code> app live in the directory <code class="docutils literal notranslate"><span class="pre">~/roses/&lt;suite-id&gt;/app/um/opt</span></code>.  Open the file <code class="docutils literal notranslate"><span class="pre">rose-app-training.conf</span></code> and edit the value for <code class="docutils literal notranslate"><span class="pre">sc</span></code>. <span class="guilabel">Save</span>, <span class="guilabel">Reload</span> and <span class="guilabel">Re-trigger</span> the suite.</p>
<p>Check the <code class="docutils literal notranslate"><span class="pre">sc</span></code> variable in the namelist file again to confirm that it does now have the correct value. This time the model should run successfully. Check the output to confirm that there are no errors.  Check that the model converged at all time steps.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="further-exercises-1.html" class="btn btn-neutral float-right" title="6. Further Exercises (1)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="fcm-tutorial.html" class="btn btn-neutral float-left" title="4. FCM tutorial" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2017-2021, NCAS-CMS.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>